/**
 * Huly Project Management Plugin for OpenCode
 * Provides comprehensive tools for full Huly workspace management
 */

import { tool } from "@opencode-ai/plugin"

const HULY_MCP_BASE_URL = process.env.HULY_MCP_BASE_URL || "http://localhost:3457"

async function postTool(toolName, args) {
  const res = await fetch(`${HULY_MCP_BASE_URL}/api/tools/${toolName}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ arguments: args || {} }),
  })
  const text = await res.text()
  let json
  try { json = JSON.parse(text) } catch { json = { success: false, error: "Invalid JSON", raw: text } }
  if (!res.ok || json?.success === false) {
    return JSON.stringify({ ok: false, status: res.status, error: json?.error || text })
  }
  return JSON.stringify({ ok: true, status: res.status, data: json.data })
}

export const HulyToolsPlugin = async (ctx) => {
  console.log(`[Huly Tools] Plugin loaded for ${ctx.project?.name || 'unknown'}`)

  return {
    tool: {
      huly_list_projects: tool({
        description: "List all Huly projects with their details",
        args: {},
        async execute(args, ctx) {
          return postTool("huly_query", { entity_type: "project", mode: "list" })
        }
      }),

      huly_get_project: tool({
        description: "Get detailed information about a specific project by identifier",
        args: {
          project_identifier: tool.schema.string()
        },
        async execute(args, ctx) {
          return postTool("huly_query", {
            entity_type: "project",
            mode: "get",
            project_identifier: args.project_identifier,
          })
        }
      }),

      huly_list_issues: tool({
        description: "List all issues in a specific project",
        args: {
          project_identifier: tool.schema.string()
        },
        async execute(args, ctx) {
          return postTool("huly_query", {
            entity_type: "issue",
            mode: "list",
            project_identifier: args.project_identifier
          })
        }
      }),

      huly_get_issue: tool({
        description: "Get detailed information about a specific issue by identifier",
        args: {
          issue_identifier: tool.schema.string()
        },
        async execute(args, ctx) {
          return postTool("huly_query", {
            entity_type: "issue",
            mode: "get",
            issue_identifier: args.issue_identifier,
          })
        }
      }),

      huly_create_issue: tool({
        description: "Create a new issue in a project with title and optional description/priority",
        args: {
          project_identifier: tool.schema.string(),
          title: tool.schema.string(),
          description: tool.schema.string(),
          priority: tool.schema.string()
        },
        async execute(args, ctx) {
          const data = { title: args.title }
          if (args.description) data.description = args.description
          if (args.priority) data.priority = args.priority

          return postTool("huly_issue_ops", {
            operation: "create",
            project_identifier: args.project_identifier,
            data: JSON.stringify(data)
          })
        }
      }),

      huly_update_issue: tool({
        description: "Update an issue field (title, description, status, priority)",
        args: {
          issue_identifier: tool.schema.string(),
          field: tool.schema.string(),
          value: tool.schema.string()
        },
        async execute(args, ctx) {
          return postTool("huly_issue_ops", {
            operation: "update",
            issue_identifier: args.issue_identifier,
            update: JSON.stringify({ field: args.field, value: args.value })
          })
        }
      }),

      huly_list_components: tool({
        description: "List all components in a project",
        args: {
          project_identifier: tool.schema.string()
        },
        async execute(args, ctx) {
          return postTool("huly_query", {
            entity_type: "component",
            mode: "list",
            project_identifier: args.project_identifier
          })
        }
      }),

      huly_list_milestones: tool({
        description: "List all milestones in a project",
        args: {
          project_identifier: tool.schema.string()
        },
        async execute(args, ctx) {
          return postTool("huly_query", {
            entity_type: "milestone",
            mode: "list",
            project_identifier: args.project_identifier
          })
        }
      }),
    }
  }
}
