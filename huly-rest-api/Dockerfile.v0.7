# Multi-stage Dockerfile for Huly REST API v0.7
# Builds SDK packages from Huly platform source and creates REST API server image

# ============================================================================
# Stage 1: Build Huly SDK packages from source
# ============================================================================
FROM node:20-alpine AS huly-sdk-builder

WORKDIR /huly

# Install build dependencies for Huly platform
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    git \
    bash

# Copy Huly platform source
COPY ["hully source/", "./"]

# Install rush (Huly uses rushjs for monorepo management)
RUN npm install -g @microsoft/rush

# Install dependencies and build SDK packages
# Initialize git repo to satisfy Rush's requirement
RUN git init && git config user.email "build@localhost" && git config user.name "Build" && git add -A && git commit -m "Initial"
RUN rush install && rush build --to @hcengineering/api-client

# ============================================================================
# Stage 2: Build REST API Server
# ============================================================================
FROM node:18-alpine AS rest-api-builder

WORKDIR /app

# Copy package files
COPY package.json ./

# Install only non-@hcengineering dependencies first (express, cors, ws, etc.)
# Remove @hcengineering dependencies from package.json before npm install
RUN node -e "const pkg=require('./package.json'); \
    const deps=pkg.dependencies||{}; \
    const newDeps={}; \
    for(const k in deps){ \
        if(!k.startsWith('@hcengineering/'))newDeps[k]=deps[k]; \
    } \
    pkg.dependencies=newDeps; \
    require('fs').writeFileSync('./package.json.temp', JSON.stringify(pkg,null,2));" && \
    mv package.json package.json.orig && \
    mv package.json.temp package.json && \
    npm install --production --legacy-peer-deps --ignore-scripts && \
    mv package.json.orig package.json

# Now copy all built SDK packages from Huly build stage
# Copy packages, plugins, models, and communication packages
COPY --from=huly-sdk-builder /huly/packages/ ./temp-packages/
COPY --from=huly-sdk-builder /huly/plugins/ ./temp-plugins/
COPY --from=huly-sdk-builder /huly/models/ ./temp-models/
COPY --from=huly-sdk-builder /huly/communication/packages/ ./temp-communication/

# Move packages to node_modules with correct naming
RUN mkdir -p ./node_modules/@hcengineering && \
    for dir in ./temp-packages/*/; do \
        pkg_name=$(basename "$dir"); \
        mv "$dir" "./node_modules/@hcengineering/$pkg_name"; \
    done && \
    for dir in ./temp-plugins/*/; do \
        pkg_name=$(basename "$dir"); \
        mv "$dir" "./node_modules/@hcengineering/$pkg_name"; \
    done && \
    for dir in ./temp-models/*/; do \
        pkg_name=$(basename "$dir"); \
        mv "$dir" "./node_modules/@hcengineering/$pkg_name"; \
    done && \
    for dir in ./temp-communication/*/; do \
        pkg_name=$(basename "$dir"); \
        mv "$dir" "./node_modules/@hcengineering/communication-$pkg_name"; \
    done && \
    rm -rf ./temp-*

# ============================================================================
# Stage 3: Final runtime image
# ============================================================================
FROM node:18-alpine

WORKDIR /app

# Copy node_modules with all dependencies
COPY --from=rest-api-builder /app/node_modules ./node_modules
COPY --from=rest-api-builder /app/package.json ./

# Copy application source
COPY server.js ./

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001 && \
    chown -R nodejs:nodejs /app

USER nodejs

# Expose port
EXPOSE 3458

# Set default environment variables
ENV NODE_ENV=production \
    PORT=3458

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3458/health', (r) => {let d=''; r.on('data', (c) => d+=c); r.on('end', () => {try{const j=JSON.parse(d); if(j.connected) process.exit(0)}catch(e){}; process.exit(1)})})"

# Start server
CMD ["node", "server.js"]
